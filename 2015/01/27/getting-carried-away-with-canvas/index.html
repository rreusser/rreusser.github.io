<!DOCTYPE html>
<html class='no-js sticky'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Getting Carried Away with Canvas | Ricky Reusser</title>
    <meta name="site" content="Ricky Reusser" />
    <meta name="og:site_name" content="Ricky Reusser" />
    <meta name="title" content="Getting Carried Away with Canvas" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Getting Carried Away with Canvas" />
    <meta name="twitter:site" content="@rickyreusser" />
    <meta name="og:title" content="Getting Carried Away with Canvas" />
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <link href="../../../../stylesheets/application-784c52a1.css" rel="stylesheet" type="text/css" />
    <link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/default.min.css' rel='stylesheet'>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </head>
  <body>
    <div class='wrapper'>
      <nav class='navbar' id='navbar'>
        <a class="menu-toggle" href="/"><span class='burger'></span>
        <span class='burger'></span>
        <span class='burger'></span>
        </a>
        <ul id='menu'>
          <li class='top'>
            <a class="brand" href="/">rickyreusser.com
            </a>
          </li>
          <li>
            <div class='padding-container'></div>
            <a href="/tags/science"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            	 width="72px" height="72px" viewBox="0 0 72 72" enable-background="new 0 0 72 72" xml:space="preserve">
              <g>
                <circle fill="#ffffff" cx="37.915" cy="34.252" r="2.165"/>
                <circle fill="#ffffff" cx="35.086" cy="34.252" r="2.165"/>
                <circle fill="#ffffff" cx="37.915" cy="37.08" r="2.165"/>
                <circle fill="#ffffff" cx="35.086" cy="37.08" r="2.165"/>
                <circle fill="#ffffff" cx="59.5" cy="43.666" r="3.888"/>
                <ellipse fill="none" stroke="#ffffff" stroke-width="3" stroke-miterlimit="10" cx="36.5" cy="35.666" rx="33.333" ry="11.167"/>
                <circle fill="#ffffff" cx="18.39" cy="51.134" r="3.889"/>
                
                  <ellipse transform="matrix(-0.4996 0.8662 -0.8662 -0.4996 85.7024 20.9105)" fill="none" stroke="#ffffff" stroke-width="3" stroke-miterlimit="10" cx="36.812" cy="35.207" rx="33.333" ry="11.167"/>
                <circle fill="#ffffff" cx="32.201" cy="12.24" r="3.889"/>
                
                  <ellipse transform="matrix(-0.4988 -0.8667 0.8667 -0.4988 23.7217 86.0485)" fill="none" stroke="#ffffff" stroke-width="3" stroke-miterlimit="10" cx="36.74" cy="36.166" rx="33.333" ry="11.167"/>
              </g>
            </svg>
            <span class='label'>science</span>
            </a>
          </li>
          <li>
            <div class='padding-container'></div>
            <a href="/tags/dev"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            	 width="72px" height="72px" viewBox="0 0 72 72" enable-background="new 0 0 72 72" xml:space="preserve">
              <g>
                <path fill="#ffffff" d="M25.295,28.367l-14.941,7.489l14.941,7.42v4.284l-18.58-9.784v-3.886l18.58-9.784V28.367z"/>
                <path fill="#ffffff" d="M41.468,15.914h3.34L30.991,55.308h-3.357L41.468,15.914z"/>
                <path fill="#ffffff" d="M47.06,28.367v-4.261l18.58,9.784v3.886l-18.58,9.784v-4.284l14.941-7.42L47.06,28.367z"/>
              </g>
            </svg>
            <span class='label'>dev</span>
            </a>
          </li>
          <li>
            <div class='padding-container'></div>
            <a id="fun" href="/tags/fun"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            	 width="72px" height="72px" viewBox="0 0 72 72" enable-background="new 0 0 72 72" xml:space="preserve">
              <g>
                <path fill="none" stroke="#ffffff" stroke-width="3" stroke-miterlimit="10" d="M54.566,58.368"/>
                <path fill="#ffffff" d="M54.244,40.188l-7.595,4.933L25.393,13.908L2.23,58.5h67.697L54.244,40.188z M25.707,19.157l7.821,11.502
                  l-1.919,5.119l-5.349-7.932l-3.208,5.65l-1.992-5.403L25.707,19.157z"/>
              </g>
            </svg>
            <span class='label'>fun</span>
            </a>
          </li>
          <li>
            <div class='padding-container'></div>
            <a href="https://github.com/rreusser"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            	 width="72px" height="72px" viewBox="0 0 72 72" enable-background="new 0 0 72 72" xml:space="preserve">
            <path fill-rule="evenodd" clip-rule="evenodd" fill="#ffffff" d="M36.21,8.152C20.488,8.152,7.738,20.9,7.738,36.629
            	c0,12.579,8.158,23.251,19.474,27.017c1.424,0.262,1.943-0.618,1.943-1.372c0-0.676-0.024-2.467-0.038-4.843
            	c-7.921,1.721-9.592-3.817-9.592-3.817c-1.295-3.289-3.161-4.165-3.161-4.165c-2.586-1.767,0.195-1.73,0.195-1.73
            	c2.857,0.201,4.361,2.934,4.361,2.934c2.54,4.352,6.664,3.096,8.287,2.366c0.258-1.84,0.994-3.095,1.808-3.807
            	c-6.323-0.719-12.971-3.161-12.971-14.072c0-3.109,1.11-5.65,2.932-7.641c-0.293-0.721-1.271-3.616,0.278-7.536
            	c0,0,2.392-0.766,7.831,2.919c2.271-0.632,4.707-0.947,7.128-0.958c2.417,0.011,4.855,0.326,7.13,0.958
            	c5.434-3.685,7.82-2.919,7.82-2.919c1.555,3.92,0.578,6.815,0.283,7.536c1.826,1.99,2.926,4.531,2.926,7.641
            	c0,10.938-6.656,13.345-13,14.05c1.023,0.88,1.934,2.617,1.934,5.273c0,3.807-0.035,6.878-0.035,7.812
            	c0,0.761,0.514,1.647,1.959,1.369c11.305-3.772,19.455-14.438,19.455-27.014C64.686,20.9,51.936,8.152,36.21,8.152z"/>
            </svg>
            <span class='label'>github</span>
            </a>
          </li>
          <li>
            <div class='padding-container'></div>
            <a href="/about"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            	 width="72px" height="72px" viewBox="0 0 72 72" enable-background="new 0 0 72 72" xml:space="preserve">
              <path fill="#ffffff" d="M53.5,55.333c-9.984-2.463-11.438-6.349-10.25-8.583c1.041-1.96,2.268-1.829,5.464-9.761
                c0.094,0.036,0.182,0.084,0.282,0.106c1.588,0.356,3.365-1.132,3.965-3.326c0.598-2.191-0.207-4.261-1.794-4.617
                c-0.083-0.019-0.168-0.012-0.252-0.021C54.667,8.497,38.667,5.997,30.167,11.247c-3.917-2.359-12.25,1.917-10.068,17.885
                c-0.084,0.009-0.155,0.002-0.238,0.021c-1.587,0.356-2.392,2.426-1.794,4.617c0.6,2.194,2.377,3.683,3.965,3.326
                c0.101-0.022,0.188-0.07,0.282-0.106c3.196,7.932,4.271,7.988,5.312,9.948c1.188,2.234,0.231,5.982-9.745,8.477
                C4.546,58.747,5.527,65.5,5.527,65.5H35.5h30C65.5,65.5,66.666,58.581,53.5,55.333z"/>
            </svg>
            <span class='label'>about me</span>
            </a>
          </li>
        </ul>
        <div class='content'></div>
        <div class='inner-content'>
          <h5 class='abbrev'>
            <span>Getting Carried Away with Canvas</span>
          </h5>
        </div>
      </nav>
      <article>
        <section class='frontmatter' data-abbrvd-target='#navbar'>
          <div class='container'>
            <div class='outer-container'>
              <div class='inner-container'>
                <h1 class='title'>Getting Carried Away with Canvas</h1>
                <h5 class='metadata'>
                  <span class='author'>Ricky Reusser</span>
                  <br>
                  <span class='published-at'>January 27, 2015</span>
                  <br>
                  <div class='tags'>
                    <span class='tag'><a href="/tags/dev/">#dev</a></span>
                    <span class='tag'><a href="/tags/canvas/">#canvas</a></span>
                    <span class='tag'><a href="/tags/html5/">#html5</a></span>
                    <span class='tag'><a href="/tags/javascript/">#javascript</a></span>
                  </div>
                </h5>
              </div>
            </div>
          </div>
        </section>
        <section class='content'>
          <p>Despite having going too far on a few&nbsp;<a href="http://happyfuncorp.com/">projects</a> with&nbsp;<a href="http://stars.akqa.com/">lots</a>&nbsp;of <a href="http://tommie.com/">visual</a> stuff <a href="http://cold-sword-7538.herokuapp.com/">going on</a>, I recently wrestled with what was supposed to be the simple task of dropping some rotating spheres from a promo video onto a splash page. There were late night rewrites and hard-learned lessons, so I&rsquo;ll walk you through what it took to make this happen.</p>
          
          <p>Here&rsquo;s the vision: Shaded spheres spin in place on top of a semi-transparent overlay. The quadrants of the spheres are either fully opaque, punch out the overlay so the background shows through, or are invisible. I know. That makes no sense. See below.</p>
          
          <p><img alt="Sphere design" src="https://s3.amazonaws.com/rickyreusser.com/spheres-concept.png" /></p>
          
          <h3>Step 1: Choose the technology</h3>
          
          <p>Feel free to brainstorm your own approach, but as for technology, it&rsquo;s either SVG or Canvas. Here are the tradeoffs:</p>
          
          <ul>
          <li><p><strong>SVG</strong>: Vector graphics. Lines and shapes are the discrete entities. Performance scales with the number of objects. You get clipping masks and blending modes, but there&rsquo;s a concern SVG may choke if it tries to <a href="http://en.wikipedia.org/wiki/Midpoint_circle_algorithm">rasterize</a>&nbsp;a bunch of circles <a href="http://www.nytimes.com/interactive/science/space/keplers-tally-of-planets.html">over and over</a>.
          <strong>Verdict</strong>: Probably possible, but potentially problematic.</p></li>
          <li><p><strong>Canvas</strong>: Raster graphics. It&rsquo;s all pixels. Performance scales with the size of the canvas. You can do blending modes and pixel effects like you would in Photoshop. The killer feature is being able to rasterize the circles once and then just add and subtract them intelligently to achieve the sphere effect.
          <strong>Verdict</strong>: Definitely possible and unlikely to be less performant than SVG.</p></li>
          </ul>
          
          <p>So that&rsquo;s it. There&rsquo;s way more subtlety to performance than is captured by my sweeping generalizations, but this step is all about knowing the difference enough to make an executive decision and go with it. In the end, canvas felt safer because there&rsquo;s more room for low-level optimization.</p>
          
          <h3>Step 2: Do the math</h3>
          
          <p>Viewed from the side like this, these spheres are just composed of ellipses and circles. Don&rsquo;t worry; I did the math just to be sure. Here&rsquo;s how I&rsquo;m breaking it down in my head:</p>
          
          <p><img alt="Image label" src="https://s3.amazonaws.com/rickyreusser.com/drawing-a-sphere.png" /></p>
          
          <p>That&rsquo;s all there is to it. Down below you&rsquo;ll see how we can use canvas buffers and canvas&rsquo;s blending modes (think: Photoshop&rsquo;s multiple, subtract, overlay, etc. layer modes) to pull this off. As for figuring out where these ellipses need to be, I&rsquo;ll do you a favor and spare you the convoluted logic it takes to actually get the job done.</p>
          
          <h3>Step 2.5: Do your homework</h3>
          
          <p>If you only take away one thing about drawing with canvases, let it be this: </p>
          
          <blockquote>
          <p>Draw shapes like lines, paths, and circles as rarely as possible. If you can, draw them once on an offscreen canvas and use <code>drawImage</code> to spit them out (<a href="http://jsperf.com/canvas-drawimage-scaling-performance">pixel-for-pixel, if you can</a>)&nbsp;onto a canvas on the page.</p>
          </blockquote>
          
          <p>No, seriously. I&rsquo;m not advocating premature optimization for everything, but the approach below is the result of a last-minute late-night rewrite because once I got this all working with the obvious method of drawing arcs on every frame, I found that Safari completely 100% locked up because it couldn&rsquo;t keep up with the number of <a href="http://www.html5canvastutorials.com/tutorials/html5-canvas-arcs/">arcs</a> I was rasterizing on each frame.</p>
          
          <h3>Step 3: Draw it</h3>
          
          <p>Enough talk. Here&rsquo;s how the pieces come together. The only step I&rsquo;ve left a little vague is adding and subtracting the half-circles to get the moon phases in the second step. But that&rsquo;s mostly just more bookkeeping. As for the other steps, you can play with the blending modes to see how it changes the result.
          <code>&#x000A;interactive-frame[width=500 height=900](/2015/01/27/canvas-demo/)</code></p>
          
          <h3>What did we learn?</h3>
          
          <p>Lots of possibilities here. One you wrap this stuff inside an animation running at 60 fps it tends to become a real cpu hog, but it&rsquo;s great for small animations and widgetsâ€”apart from the setup at least. To help out that part, I&rsquo;m slowly putting together a library of functions to facilitate the process. You can get the source code here:</p>
          
          <p><a href="https://github.com/rreusser/canvas-toolbox">https://github.com/rreusser/canvas-toolbox</a></p>
        </section>
      </article>
      <div class='push'></div>
    </div>
    <section class='footer'>
      <div class='container'>
        <div class='article-footer'>
          <div id='disqus_thread'></div>
          <script>
              var disqus_shortname = 'rickyreusser';
              (function() {
                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
          </script>
          <noscript>
            Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
          </noscript>
        </div>
        <!--div class="sharing">
        <a href="http://www.twitter.com/share?url=<%= data['site']['siteurl'] %><%= current_article.url %>&amp;text=<%= current_article.title %> by <%= data['site']['twitter_id'] %>" title="Share this post on Twitter" data-lang="en" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')"><span class="socicon socicon-twitter fgcolor"></span></a>
        <a target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')" href="http://www.facebook.com/sharer/sharer.php?u=<%= data['site']['siteurl'] %><%= current_article.url %>" title="Share this post on Facebook"><span class="socicon socicon-facebook fgcolor"></span></a>
        <a href="http://plus.google.com/share?url=<%= data['site']['siteurl'] %><%= current_article.url %>" target="_blank" onclick="return !window.open(this.href, 'Google +', 'width=640,height=300')" title="Share this post on Google +"><span class="socicon socicon-google fgcolor"></span></a>
        </div-->
      </div>
    </section>
    <script src="../../../../javascripts/all-246a8123.js" type="text/javascript"></script>
    <script>
      var _gaq=[['_setAccount','UA-50197543-4'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
    <script>
      $('code').each(function(i,el) {
        var $el = $(el);
        var html = $el.html();
        if( html.match(/^\${1,2}.*\${1,2}$/) || html.match(/^\\\(.*\\\)$/) ){
          var container = $('<span>');
          container.html(html);
          $el.replaceWith(container);
        }
      });
    </script>
  </body>
</html>
